@app.route("/upload", methods=["GET", "POST"])
def upload():
    if "user" not in session:
        return redirect(url_for("login"))

    if request.method == "POST":
        file = request.files["file"]
        if not file:
            return render_template("upload.html", error="âš ï¸ íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

        try:
            # âœ… ì—‘ì…€ / CSV ìë™ íŒë³„ + ë””ë²„ê¹…ìš© ë¡œê¹…
            if file.filename.endswith(".xlsx"):
                df = pd.read_excel(file, dtype=str)
            else:
                df = pd.read_csv(file, dtype=str)

            print("\nğŸ“‚ [DEBUG] íŒŒì¼ëª…:", file.filename)
            print("ğŸ“‹ [DEBUG] ì›ë³¸ ì»¬ëŸ¼ ëª©ë¡:", list(df.columns))
            print("ğŸ” [DEBUG] ì´ í–‰ ìˆ˜:", len(df))
            print("ğŸ§¾ [DEBUG] ì²« 3í–‰ ë¯¸ë¦¬ë³´ê¸°:\n", df.head(3))
            print("-" * 60)

        except Exception as e:
            print("âŒ [ERROR] ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜:", e)
            return render_template("upload.html", error=f"âŒ ì—‘ì…€ íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")

        # âœ… ì»¬ëŸ¼ëª… ì „ì²˜ë¦¬: ê³µë°± ì œê±°, ì†Œë¬¸ì ë³€í™˜
        df.columns = [str(c).strip().lower() for c in df.columns]
        print("âœ… [DEBUG] ì •ì œëœ ì»¬ëŸ¼ëª…:", df.columns.tolist())

        # âœ… ê°€ëŠ¥í•œ ì»¬ëŸ¼ ì´ë¦„ ë§¤í•‘
        address_cols = ["address", "ì£¼ì†Œ", "ì£¼ì†Œì§€"]
        meter_cols = ["meters", "ê³„ê¸°ë²ˆí˜¸", "ê³„ê¸°", "meter"]

        dataset = session["dataset"]
        inserted = 0

        for _, row in df.iterrows():
            # âœ… addressì™€ meter ìë™ íƒì§€
            address = ""
            for c in address_cols:
                if c.lower() in df.columns:
                    address = str(row[c.lower()]).strip()
                    break

            meter = ""
            for c in meter_cols:
                if c.lower() in df.columns:
                    meter = str(row[c.lower()]).strip()
                    break

            if not address:
                continue

            # âœ… Kakao Local API í˜¸ì¶œ
            url = f"https://dapi.kakao.com/v2/local/search/address.json?query={urllib.parse.quote(address)}"
            headers = {"Authorization": f"KakaoAK {KAKAO_API_KEY}"}
            res = requests.get(url, headers=headers)
            data = res.json()

            if data.get("documents"):
                loc = data["documents"][0]
                x, y = float(loc["x"]), float(loc["y"])
                postal_code = loc.get("road_address", {}).get("zone_no") if loc.get("road_address") else None

                supabase.table("field_data").insert({
                    "dataset": dataset,
                    "address": address,
                    "meters": [meter],
                    "x": x,
                    "y": y,
                    "postal_code": postal_code,
                    "status": "ë¯¸ë°©ë¬¸"
                }).execute()
                inserted += 1

        print(f"âœ… [DEBUG] ì´ {inserted}ê°œì˜ ì£¼ì†Œê°€ ë³€í™˜ë˜ì–´ Supabaseì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n")

        return render_template("upload.html", message=f"âœ… {inserted}ê°œì˜ ì£¼ì†Œê°€ ì—…ë¡œë“œ ë° ë³€í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.")
    return render_template("upload.html")
